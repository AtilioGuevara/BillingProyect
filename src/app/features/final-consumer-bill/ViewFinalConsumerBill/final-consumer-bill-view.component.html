<div class="bill-view-container">
  <!-- Header -->
  <div class="bill-header">
    <h2>Detalle de Factura</h2>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Volver
      </button>
      <button class="btn btn-primary" (click)="goToCreate()">
        <i class="fas fa-plus"></i> Nueva Factura
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando factura...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-card">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Error al cargar la factura</h3>
      <pre class="error-details">{{ error }}</pre>
      <div class="error-actions">
        <button class="btn btn-secondary" (click)="goBack()">
          <i class="fas fa-arrow-left"></i> Volver a Búsqueda
        </button>
        <button class="btn btn-primary" (click)="goToCreate()">
          <i class="fas fa-plus"></i> Crear Nueva Factura
        </button>
      </div>
    </div>
  </div>

  <!-- Bill Content -->
  <div *ngIf="bill && !loading && !error" class="bill-content">
    <!-- Bill Actions -->
    <div class="bill-actions">
      <button class="btn btn-success" (click)="printBill()">
        <i class="fas fa-print"></i> Imprimir
      </button>
    </div>

    <!-- Bill Details Card -->
    <div class="bill-card">
      <!-- Basic Information -->
      <div class="bill-section">
        <h3>Información General</h3>
        <div class="info-grid">
          <div class="info-item">
            <label>Código de Generación:</label>
            <span class="generation-code">{{ bill.generationCode }}</span>
          </div>
          <div class="info-item">
            <label>Número de Control:</label>
            <span>{{ bill.controlNumber }}</span>
          </div>
          <div class="info-item">
            <label>Fecha de Generación:</label>
            <span>{{ bill.billGenerationDate | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="info-item">
            <label>Condición de Pago:</label>
            <span>{{ bill.paymentCondition }}</span>
          </div>
        </div>
      </div>

      <!-- Customer Information -->
      <div class="bill-section" *ngIf="bill.receiver?.customerName">
        <h3>Información del Cliente</h3>
        <div class="info-grid">
          <div class="info-item" *ngIf="bill.receiver.customerName">
            <label>Nombre:</label>
            <span>{{ bill.receiver.customerName }} {{ bill.receiver.customerLastname }}</span>
          </div>
          <div class="info-item" *ngIf="bill.receiver.customerDocument">
            <label>Documento:</label>
            <span>{{ bill.receiver.customerDocument }}</span>
          </div>
          <div class="info-item" *ngIf="bill.receiver.customerEmail">
            <label>Email:</label>
            <span>{{ bill.receiver.customerEmail }}</span>
          </div>
          <div class="info-item" *ngIf="bill.receiver.customerPhone">
            <label>Teléfono:</label>
            <span>{{ bill.receiver.customerPhone }}</span>
          </div>
          <div class="info-item" *ngIf="bill.receiver.customerAddress">
            <label>Dirección:</label>
            <span>{{ bill.receiver.customerAddress }}</span>
          </div>
        </div>
      </div>

      <!-- Company Information -->
      <div class="bill-section" *ngIf="bill.transmitter?.companyName">
        <h3>Información de la Empresa</h3>
        <div class="info-grid">
          <div class="info-item">
            <label>Nombre:</label>
            <span>{{ bill.transmitter.companyName }}</span>
          </div>
          <div class="info-item" *ngIf="bill.transmitter.companyDocument">
            <label>Documento:</label>
            <span>{{ bill.transmitter.companyDocument }}</span>
          </div>
          <div class="info-item" *ngIf="bill.transmitter.companyEmail">
            <label>Email:</label>
            <span>{{ bill.transmitter.companyEmail }}</span>
          </div>
          <div class="info-item" *ngIf="bill.transmitter.companyPhone">
            <label>Teléfono:</label>
            <span>{{ bill.transmitter.companyPhone }}</span>
          </div>
          <div class="info-item" *ngIf="bill.transmitter.companyAddress">
            <label>Dirección:</label>
            <span>{{ bill.transmitter.companyAddress }}</span>
          </div>
        </div>
      </div>

      <!-- Products Table -->
      <div class="bill-section" *ngIf="bill.products && bill.products.length > 0">
        <h3>Productos/Servicios</h3>
        <div class="table-responsive">
          <table class="items-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let product of bill.products">
                <td>{{ product.name }}</td>
                <td>{{ product.requestedQuantity }}</td>
                <td>{{ product.price | currency:'USD':'symbol':'1.2-2' }}</td>
                <td>{{ product.subTotal | currency:'USD':'symbol':'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Promotions Section -->
      <div class="bill-section" *ngIf="bill?.promotionApplied">
        <h3>Promoción Aplicada</h3>
        <div class="info-grid">
          <div class="info-item">
            <label>Código de Promoción:</label>
            <span>{{ bill.promotionCode || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <label>Nombre de Promoción:</label>
            <span>{{ bill.promotionName || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <label>Descuento Aplicado:</label>
            <span>{{ (bill.promotionDiscount || 0) | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="info-item" *ngIf="bill.productsWithPromotion && bill.productsWithPromotion.length > 0">
            <label>Productos con Promoción:</label>
            <span>
              <span *ngFor="let productId of bill.productsWithPromotion; let i = index">
                {{ getProductNameById(productId) }}<span *ngIf="i < (bill.productsWithPromotion?.length || 0) - 1">, </span>
              </span>
            </span>
          </div>
        </div>
      </div>

      <!-- Totals -->
      <div class="bill-section">
        <h3>Totales</h3>
        <div class="totals-grid">
          <div class="total-item" *ngIf="bill.nonTaxedSales > 0">
            <label>Ventas No Sujetas:</label>
            <span>{{ bill.nonTaxedSales | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-item" *ngIf="bill.exemptSales > 0">
            <label>Ventas Exentas:</label>
            <span>{{ bill.exemptSales | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-item" *ngIf="bill.taxedSales > 0">
            <label>Ventas Gravadas:</label>
            <span>{{ bill.taxedSales | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-item" *ngIf="bill.iva > 0">
            <label>IVA (13%):</label>
            <span>{{ bill.iva | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-item" *ngIf="bill.perceivedIva > 0">
            <label>IVA Percibido:</label>
            <span>{{ bill.perceivedIva | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-item" *ngIf="bill.withheldIva > 0">
            <label>IVA Retenido:</label>
            <span>{{ bill.withheldIva | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="total-item total-final">
            <label>Total con IVA:</label>
            <span>{{ bill.totalWithIva | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>