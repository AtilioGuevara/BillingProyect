<app-final-consumer-bill-nav></app-final-consumer-bill-nav>

<div>
  <div class="card">
    <div class="card-header">
      <div class="items-center gap-3 md:flex">
        <h6 class="grow mb-3 md:mb-0">Crear Factura Consumidor Final</h6>
        <div class="flex flex-wrap items-center gap-2 shrink-0">
          <button type="button" class="btn btn-sub-gray" (click)="clearForm()">
            <i class="align-baseline ri-refresh-line"></i>
            Limpiar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="loading" (click)="submit()">
            <i class="align-baseline ri-save-line"></i>
            <span *ngIf="!loading">Guardar Factura</span>
            <span *ngIf="loading">Guardando...</span>
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Mensaje de √©xito prominente al inicio -->
      <div *ngIf="successMsg" class="mb-6 p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg shadow-sm relative">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ri-check-circle-fill text-3xl text-green-500"></i>
          </div>
          <div class="ml-4 flex-grow">
            <h3 class="text-lg font-bold text-green-800">¬°Factura Creada Exitosamente! üéâ</h3>
            <p class="text-green-700 mt-1 whitespace-pre-line">{{ successMsg }}</p>
            <small class="text-green-600 mt-2 block">Este mensaje se ocultar√° autom√°ticamente en 20 segundos</small>
          </div>
          <button type="button" (click)="closeSuccessMessage()" class="absolute top-2 right-2 text-green-600 hover:text-green-800 text-xl" title="Cerrar mensaje">
            <i class="ri-close-line"></i>
          </button>
        </div>
      </div>
      
      <form [formGroup]="billForm" (ngSubmit)="submit()">
        
        <!-- Informaci√≥n General -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Informaci√≥n General</h6>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- M√©todo de pago -->
            <div>
              <label for="paymentCondition" class="form-label">M√©todo de pago *</label>
              <select id="paymentCondition" formControlName="paymentCondition" class="form-input">
                <option value="" disabled selected hidden>Seleccione m√©todo de pago</option>
                <option value="EFECTIVO">Efectivo</option>
                <option value="TARJETA">Tarjeta de cr√©dito/d√©bito</option>
              </select>
              <div *ngIf="isFieldEmpty('paymentCondition')" class="text-red-500 text-sm mt-1">
                M√©todo de pago es requerido
              </div>
            </div>
          </div>
        </div>
        
        <!-- Informaci√≥n del Cliente -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Informaci√≥n del Cliente</h6>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Nombre del cliente -->
            <div>
              <label for="customerName" class="form-label">Nombre del cliente *</label>
              <input type="text" id="customerName" formControlName="customerName" 
                     class="form-input" 
                     maxlength="50"
                     [class.border-red-500]="hasFieldErrors('customerName')"
                     [class.border-green-500]="isFieldValid('customerName')"
                     [placeholder]="placeholders.customerName">
              <div class="flex justify-between items-center mt-1">
                <div>
                  <div *ngIf="hasFieldErrors('customerName')" class="text-red-500 text-sm">
                    {{ getFieldErrorMessage('customerName') }}
                  </div>
                  <div *ngIf="isFieldValid('customerName')" class="text-green-500 text-sm">
                    <i class="ri-check-line"></i> Nombre v√°lido
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  {{ getFieldLength('customerName') }}/50
                </div>
              </div>
            </div>

            <!-- Apellido del cliente -->
            <div>
              <label for="customerLastname" class="form-label">Apellido del cliente</label>
              <input type="text" id="customerLastname" formControlName="customerLastname" 
                     class="form-input" 
                     maxlength="50"
                     [class.border-green-500]="isFieldValid('customerLastname')"
                     placeholder="Ej: Garc√≠a Mart√≠nez (opcional)">
              <div class="flex justify-between items-center mt-1">
                <div>
                  <div *ngIf="isFieldValid('customerLastname')" class="text-green-500 text-sm">
                    <i class="ri-check-line"></i> Apellido v√°lido
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  {{ getFieldLength('customerLastname') }}/50
                </div>
              </div>
            </div>
            
            <!-- Documento del cliente -->
            <div>
              <label for="customerDocument" class="form-label">Documento del cliente *</label>
              <input type="text" id="customerDocument" formControlName="customerDocument" 
                     class="form-input" 
                     [class.border-red-500]="hasFieldErrors('customerDocument')"
                     [class.border-green-500]="isFieldValid('customerDocument')"
                     [placeholder]="placeholders.customerDocument">
              <div *ngIf="hasFieldErrors('customerDocument')" class="text-red-500 text-sm mt-1">
                {{ getFieldErrorMessage('customerDocument') }}
              </div>
              <div *ngIf="isFieldValid('customerDocument')" class="text-green-500 text-sm mt-1">
                <i class="ri-check-line"></i> DUI v√°lido
              </div>
            </div>
            
            <!-- Email del cliente -->
            <div>
              <label for="customerEmail" class="form-label">Email del cliente *</label>
              <input type="email" id="customerEmail" formControlName="customerEmail" 
                     class="form-input"
                     [class.border-red-500]="hasFieldErrors('customerEmail')"
                     [class.border-green-500]="isFieldValid('customerEmail')"
                     [placeholder]="placeholders.customerEmail">
              <div *ngIf="hasFieldErrors('customerEmail')" class="text-red-500 text-sm mt-1">
                {{ getFieldErrorMessage('customerEmail') }}
              </div>
              <div *ngIf="isFieldValid('customerEmail')" class="text-green-500 text-sm mt-1">
                <i class="ri-check-line"></i> Email v√°lido
              </div>
            </div>
            
            <!-- Tel√©fono del cliente -->
            <div>
              <label for="customerPhone" class="form-label">Tel√©fono del cliente *</label>
              <input type="text" id="customerPhone" formControlName="customerPhone" 
                     class="form-input"
                     [class.border-red-500]="hasFieldErrors('customerPhone')"
                     [class.border-green-500]="isFieldValid('customerPhone')"
                     [placeholder]="placeholders.customerPhone">
              <div *ngIf="hasFieldErrors('customerPhone')" class="text-red-500 text-sm mt-1">
                {{ getFieldErrorMessage('customerPhone') }}
              </div>
              <div *ngIf="isFieldValid('customerPhone')" class="text-green-500 text-sm mt-1">
                <i class="ri-check-line"></i> Tel√©fono v√°lido
              </div>
            </div>
            
            <!-- Direcci√≥n del cliente -->
            <div class="md:col-span-2">
              <label for="customerAddress" class="form-label">Direcci√≥n del cliente *</label>
              <input type="text" id="customerAddress" formControlName="customerAddress" 
                     class="form-input" 
                     maxlength="200"
                     [class.border-red-500]="hasFieldErrors('customerAddress')"
                     [class.border-green-500]="isFieldValid('customerAddress')"
                     [placeholder]="placeholders.customerAddress">
              <div class="flex justify-between items-center mt-1">
                <div>
                  <div *ngIf="hasFieldErrors('customerAddress')" class="text-red-500 text-sm">
                    {{ getFieldErrorMessage('customerAddress') }}
                  </div>
                  <div *ngIf="isFieldValid('customerAddress')" class="text-green-500 text-sm">
                    <i class="ri-check-line"></i> Direcci√≥n v√°lida
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  {{ getFieldLength('customerAddress') }}/200
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Productos</h6>
          <div class="space-y-4" formArrayName="products">
            <div *ngFor="let product of products.controls; let i = index" [formGroupName]="i"
                 class="grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-gray-50 rounded-lg border">
              <!-- N√∫mero -->
              <div class="md:col-span-1 flex items-center">
                <span class="font-semibold text-gray-600">{{ i + 1 }}</span>
              </div>
              
              <!-- Lista de Productos de Inventario -->
              <div class="md:col-span-5">
                <label class="form-label text-sm">Seleccionar Producto (Solo Activos) *</label>
                <select 
                  formControlName="productId" 
                  class="form-input"
                  (change)="onProductSelected($event, i)">
                  <option value="">-- Seleccione un producto --</option>
                  <option *ngFor="let product of productsList" 
                          [value]="product.id">
                    {{ product.name }} - ID: {{ product.id }}{{ product.price ? ' - $' + product.price : '' }}
                  </option>
                </select>
                <div *ngIf="isProductFieldEmpty(i, 'productId')" class="text-red-500 text-sm mt-1">
                  Debe seleccionar un producto
                </div>
              </div>
              
              <!-- Cantidad Solicitada -->
              <div class="md:col-span-5">
                <label class="form-label text-sm">Cantidad Solicitada *</label>
                <input type="number" formControlName="requestedQuantity" class="form-input" [placeholder]="placeholders.requestedQuantity" min="1">
                <div *ngIf="isProductFieldEmpty(i, 'requestedQuantity')" class="text-red-500 text-sm mt-1">
                  Cantidad es requerida
                </div>
              </div>
              
              <!-- Acciones -->
              <div class="md:col-span-1 flex items-end">
                <button type="button" (click)="removeProduct(i)" class="btn btn-outline-danger btn-sm w-full" *ngIf="products.length > 1">
                  <i class="align-baseline ri-delete-bin-line"></i>
                </button>
              </div>
            </div>
            
            <!-- Bot√≥n agregar producto -->
            <div class="flex justify-start">
              <button type="button" (click)="addProduct()" class="btn btn-primary">
                <i class="align-bottom ri-add-line"></i> Agregar Producto
              </button>
            </div>
          </div>
        </div>



        <!-- Mensajes de estado -->
        <div class="mt-6">
          <!-- Mensaje de carga -->
          <div *ngIf="loading" class="alert alert-info flex items-center p-4 mb-4 text-blue-800 border border-blue-300 rounded-lg bg-blue-50">
            <i class="align-baseline ri-loader-line animate-spin mr-3 text-lg"></i>
            <span class="font-medium">Enviando factura...</span>
          </div>
          
          <!-- Mensaje de √©xito -->
          <div *ngIf="successMsg" class="alert alert-success flex items-start p-4 mb-4 text-green-800 border border-green-300 rounded-lg bg-green-50 relative">
            <i class="align-baseline ri-check-circle-line mr-3 text-xl text-green-600"></i>
            <div class="flex-grow">
              <h4 class="font-bold text-lg mb-2">¬°Factura Creada Exitosamente!</h4>
              <p class="whitespace-pre-line">{{ successMsg }}</p>
              <small class="text-green-600 mt-2 block">Mensaje visible por 20 segundos</small>
            </div>
            <button type="button" (click)="closeSuccessMessage()" class="absolute top-2 right-2 text-green-600 hover:text-green-800 text-lg" title="Cerrar mensaje">
              <i class="ri-close-line"></i>
            </button>
          </div>
          
          <!-- Mensaje de error -->
          <div *ngIf="errorMsg" class="alert alert-danger flex items-center p-4 mb-4 text-red-800 border border-red-300 rounded-lg bg-red-50">
            <i class="align-baseline ri-error-warning-line mr-3 text-lg text-red-600"></i>
            <span>{{ errorMsg }}</span>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
