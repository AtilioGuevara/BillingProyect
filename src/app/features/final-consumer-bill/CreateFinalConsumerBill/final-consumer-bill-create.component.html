<app-final-consumer-bill-nav></app-final-consumer-bill-nav>

<div>
  <div class="card">
    <div class="card-header bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-blue-100">
      <div class="items-center gap-3 md:flex">
        <div class="grow mb-3 md:mb-0">
          <h6 class="text-xl font-bold text-gray-800 mb-1">
            <i class="ri-file-add-line text-blue-600 mr-2"></i>
            <span *ngIf="!isReturnMode">Crear Factura Consumidor Final</span>
            <span *ngIf="isReturnMode">Crear Devoluci√≥n de Factura</span>
          </h6>
          <p class="text-sm text-gray-600" *ngIf="!isReturnMode">Complete los datos para generar una nueva factura</p>
          <p class="text-sm text-gray-600" *ngIf="isReturnMode">
            <i class="ri-arrow-go-back-line mr-1"></i>
            Procesando devoluci√≥n para factura: <code class="bg-gray-100 px-2 py-1 rounded text-xs text-gray-700">{{ originalBillCode }}</code>
          </p>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Mensaje de √©xito prominente al inicio -->
      <div *ngIf="successMsg" class="mb-6 p-6 bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg shadow-sm relative">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ri-check-circle-fill text-3xl text-green-500"></i>
          </div>
          <div class="ml-4 flex-grow">
            <h3 class="text-lg font-bold text-green-800">¬°Factura Creada Exitosamente! üéâ</h3>
            <p class="text-green-700 mt-1 whitespace-pre-line">{{ successMsg }}</p>
            <small class="text-green-600 mt-2 block">Este mensaje se ocultar√° autom√°ticamente en 20 segundos</small>
          </div>
          <button type="button" (click)="closeSuccessMessage()" class="absolute top-2 right-2 text-green-600 hover:text-green-800 text-xl" title="Cerrar mensaje">
            <i class="ri-close-line"></i>
          </button>
        </div>
      </div>
      
      <form [formGroup]="billForm" (ngSubmit)="submit()">
        
        <!-- Informaci√≥n General -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Informaci√≥n General</h6>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- M√©todo de pago -->
            <div>
              <label for="paymentCondition" class="form-label">M√©todo de Pago *</label>
              <select id="paymentCondition" formControlName="paymentCondition" class="form-input" (change)="onPaymentMethodChange()">
                <option value="">-- Seleccione m√©todo de pago --</option>
                <option value="EFECTIVO">Efectivo</option>
                <option value="TARJETA_DEBITO">Tarjeta de D√©bito</option>
                <option value="TARJETA_CREDITO">Tarjeta de Cr√©dito</option>
              </select>
            </div>

            <!-- Informaci√≥n del m√©todo seleccionado -->
            <div *ngIf="selectedPaymentMethod" class="mt-3 p-3 bg-blue-50 border">
              <div class="flex items-center gap-2 mb-2">
                <i [class]="getPaymentMethodIcon(selectedPaymentMethod)" class="text-blue-600"></i>
                <span class="font-semibold text-blue-800">{{ getPaymentMethodName(selectedPaymentMethod) }}</span>
              </div>
              <p class="text-sm text-blue-700">{{ getPaymentMethodDescription(selectedPaymentMethod) }}</p>
            </div>
            
            <div *ngIf="isFieldEmpty('paymentCondition')" class="text-red-500 text-sm mt-1">
              <i class="ri-error-warning-line"></i> M√©todo de pago es requerido
            </div>
          </div>
        </div>
        
        <!-- Informaci√≥n del Cliente -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Informaci√≥n del Cliente</h6>
          
          <!-- B√∫squeda de clientes existentes -->
          <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
            <div class="flex items-center gap-2 mb-3">
              <i class="ri-search-line text-blue-600"></i>
              <h6 class="text-sm font-semibold text-blue-800">Buscar Cliente Existente</h6>
            </div>
            <div class="relative">
              <input 
                type="text" 
                [(ngModel)]="clientSearchTerm"
                (input)="onClientSearchChange($event.target.value)"
                (blur)="closeClientDropdown()"
                class="form-input w-full pr-10"
                placeholder="Escriba el nombre del cliente para buscar..."
                autocomplete="off">
              
              <!-- √çcono de carga -->
              <div *ngIf="loadingClients" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                <i class="ri-loader-line animate-spin text-blue-600"></i>
              </div>
              
              <!-- Bot√≥n para limpiar b√∫squeda -->
              <button 
                *ngIf="clientSearchTerm && !loadingClients" 
                type="button"
                (click)="clearClientSearch()"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <i class="ri-close-line"></i>
              </button>
              
              <!-- Dropdown con resultados -->
              <div *ngIf="showClientDropdown" 
                   class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                <div *ngFor="let client of clientSearchResults; trackBy: trackByClientId" 
                     (mousedown)="selectClient(client)"
                     class="px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0">
                  <div class="flex items-start justify-between">
                    <div class="flex-grow">
                      <div class="font-semibold text-gray-800">
                        {{ client.nombre }} {{ client.apellido }}
                      </div>
                      <div class="text-sm text-gray-600 mt-1">
                        <i class="ri-mail-line mr-1"></i>{{ client.correo }}
                      </div>
                      <div class="text-sm text-gray-600">
                        <i class="ri-phone-line mr-1"></i>{{ client.telefono }}
                      </div>
                    </div>
                    <div class="text-xs text-gray-500 ml-3">
                      DUI: {{ client.dui }}
                    </div>
                  </div>
                </div>
                
                <!-- Mensaje cuando no hay resultados -->
                <div *ngIf="clientSearchResults.length === 0 && clientSearchTerm.length >= 2 && !loadingClients" 
                     class="px-4 py-3 text-gray-500 text-center">
                  <i class="ri-information-line mr-1"></i>
                  No se encontraron clientes con ese nombre
                </div>
              </div>
            </div>
            <p class="text-xs text-blue-600 mt-2">
              <i class="ri-lightbulb-line mr-1"></i>
              Escriba al menos 2 caracteres para buscar clientes existentes. Si selecciona un cliente, los campos se rellenar√°n autom√°ticamente.
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Nombre del cliente -->
            <div>
              <label for="customerName" class="form-label">Nombre del cliente *</label>
              <input type="text" id="customerName" formControlName="customerName" 
                     class="form-input" 
                     maxlength="50"
                     [class.border-red-500]="hasFieldErrors('customerName')"
                     [class.border-green-500]="isFieldValid('customerName')"
                     [placeholder]="placeholders.customerName">
              <div class="flex justify-between items-center mt-1">
                <div>
                  <div *ngIf="hasFieldErrors('customerName')" class="text-red-500 text-sm">
                    {{ getFieldErrorMessage('customerName') }}
                  </div>
                  <div *ngIf="isFieldValid('customerName')" class="text-green-500 text-sm">
                    <i class="ri-check-line"></i> Nombre v√°lido
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  {{ getFieldLength('customerName') }}/50
                </div>
              </div>
            </div>

            <!-- Apellido del cliente -->
            <div>
              <label for="customerLastname" class="form-label">Apellido del cliente</label>
              <input type="text" id="customerLastname" formControlName="customerLastname" 
                     class="form-input" 
                     maxlength="50"
                     [class.border-green-500]="isFieldValid('customerLastname')"
                     placeholder="Ej: Garc√≠a Mart√≠nez (opcional)">
              <div class="flex justify-between items-center mt-1">
                <div>
                  <div *ngIf="isFieldValid('customerLastname')" class="text-green-500 text-sm">
                    <i class="ri-check-line"></i> Apellido v√°lido
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  {{ getFieldLength('customerLastname') }}/50
                </div>
              </div>
            </div>
            
            <!-- Documento del cliente -->
            <div>
              <label for="customerDocument" class="form-label">Documento del cliente *</label>
              <input type="text" id="customerDocument" formControlName="customerDocument" 
                     class="form-input" 
                     [class.border-red-500]="hasFieldErrors('customerDocument')"
                     [class.border-green-500]="isFieldValid('customerDocument')"
                     [placeholder]="placeholders.customerDocument">
              <div *ngIf="hasFieldErrors('customerDocument')" class="text-red-500 text-sm mt-1">
                {{ getFieldErrorMessage('customerDocument') }}
              </div>
              <div *ngIf="isFieldValid('customerDocument')" class="text-green-500 text-sm mt-1">
                <i class="ri-check-line"></i> DUI v√°lido
              </div>
            </div>
            
            <!-- Email del cliente -->
            <div>
              <label for="customerEmail" class="form-label">Email del cliente *</label>
              <input type="email" id="customerEmail" formControlName="customerEmail" 
                     class="form-input"
                     [class.border-red-500]="hasFieldErrors('customerEmail')"
                     [class.border-green-500]="isFieldValid('customerEmail')"
                     [placeholder]="placeholders.customerEmail">
              <div *ngIf="hasFieldErrors('customerEmail')" class="text-red-500 text-sm mt-1">
                {{ getFieldErrorMessage('customerEmail') }}
              </div>
              <div *ngIf="isFieldValid('customerEmail')" class="text-green-500 text-sm mt-1">
                <i class="ri-check-line"></i> Email v√°lido
              </div>
            </div>
            
            <!-- Tel√©fono del cliente -->
            <div>
              <label for="customerPhone" class="form-label">Tel√©fono del cliente *</label>
              <input type="text" id="customerPhone" formControlName="customerPhone" 
                     class="form-input"
                     [class.border-red-500]="hasFieldErrors('customerPhone')"
                     [class.border-green-500]="isFieldValid('customerPhone')"
                     [placeholder]="placeholders.customerPhone">
              <div *ngIf="hasFieldErrors('customerPhone')" class="text-red-500 text-sm mt-1">
                {{ getFieldErrorMessage('customerPhone') }}
              </div>
              <div *ngIf="isFieldValid('customerPhone')" class="text-green-500 text-sm mt-1">
                <i class="ri-check-line"></i> Tel√©fono v√°lido
              </div>
            </div>
            
            <!-- Direcci√≥n del cliente -->
            <div class="md:col-span-2">
              <label for="customerAddress" class="form-label">Direcci√≥n del cliente *</label>
              <input type="text" id="customerAddress" formControlName="customerAddress" 
                     class="form-input" 
                     maxlength="200"
                     [class.border-red-500]="hasFieldErrors('customerAddress')"
                     [class.border-green-500]="isFieldValid('customerAddress')"
                     [placeholder]="placeholders.customerAddress">
              <div class="flex justify-between items-center mt-1">
                <div>
                  <div *ngIf="hasFieldErrors('customerAddress')" class="text-red-500 text-sm">
                    {{ getFieldErrorMessage('customerAddress') }}
                  </div>
                  <div *ngIf="isFieldValid('customerAddress')" class="text-green-500 text-sm">
                    <i class="ri-check-line"></i> Direcci√≥n v√°lida
                  </div>
                </div>
                <div class="text-xs text-gray-500">
                  {{ getFieldLength('customerAddress') }}/200
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Productos</h6>
          <div class="space-y-4" formArrayName="products">
            <div *ngFor="let product of products.controls; let i = index" [formGroupName]="i"
                 class="grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-gray-50 rounded-lg border">
              <!-- N√∫mero -->
              <div class="md:col-span-1 flex items-center">
                <span class="font-semibold text-gray-600">{{ i + 1 }}</span>
              </div>
              
              <!-- Lista de Productos de Inventario -->
              <div class="md:col-span-5">
                <label class="form-label text-sm">Seleccionar Producto *</label>
                <select 
                  formControlName="productId" 
                  class="form-input"
                  (change)="onProductSelected($event, i)">
                  <option value="">-- Seleccione un producto --</option>
                  <option *ngFor="let product of productsList" [value]="product.productoId">
                    {{ product.nombre }}
                  </option>
                </select>
              </div>

              <!-- Mostrar el precio del producto seleccionado -->
              <div class="md:col-span-2">
                <label class="form-label text-sm">Precio Unitario</label>
                <input type="text" formControlName="precio" class="form-input">
              </div>
              
              <!-- Cantidad Solicitada -->
              <div class="md:col-span-5">
                <label class="form-label text-sm">Cantidad Solicitada *</label>
                <input type="number" formControlName="requestedQuantity" class="form-input" min="1">
              </div>
              
              <!-- Acciones -->
              <div class="md:col-span-1 flex items-end">
                <button type="button" (click)="removeProduct(i)" class="btn btn-outline-danger btn-sm w-full" *ngIf="products.length > 1">
                  <i class="align-baseline ri-delete-bin-line"></i>
                </button>
              </div>
            </div>
            
            <!-- Bot√≥n agregar producto -->
            <div class="flex justify-start">
              <button type="button" (click)="addProduct()" class="btn btn-primary">
                <i class="align-bottom ri-add-line"></i> Agregar Producto
              </button>
            </div>
          </div>
        </div>

        <!-- Campos para el pago con tarjeta -->
        <div *ngIf="billForm.get('paymentCondition')?.value === 'TARJETA_DEBITO' || billForm.get('paymentCondition')?.value === 'TARJETA_CREDITO'" formGroupName="payment" class="mt-4">
          <div>
            <label for="cardType" class="form-label">Tipo de Tarjeta *</label>
            <select id="cardType" formControlName="cardType" class="form-input">
              <option value="">-- Seleccione el tipo de tarjeta --</option>
              <option value="VISA">VISA</option>
              <option value="MASTERCARD">MasterCard</option>
              <option value="AMEX">American Express</option>
              <option value="DISCOVER">Discover</option>
            </select>
            <div *ngIf="hasFieldErrors('payment.cardType')" class="text-red-500 text-sm mt-1">
              <i class="ri-error-warning-line"></i> Tipo de tarjeta es requerido
            </div>
          </div>

          <div>
            <label for="maskedCardNumber" class="form-label">N√∫mero de Tarjeta *</label>
            <input
              id="maskedCardNumber"
              type="text"
              formControlName="maskedCardNumber"
              class="form-input"
              placeholder="4512345678901234"
            />
            <div *ngIf="hasFieldErrors('payment.maskedCardNumber')" class="text-red-500 text-sm mt-1">
              <i class="ri-error-warning-line"></i> N√∫mero de tarjeta es requerido y debe ser v√°lido
            </div>
          </div>

          <div>
            <label for="cardHolder" class="form-label">Titular de la Tarjeta *</label>
            <input
              id="cardHolder"
              type="text"
              formControlName="cardHolder"
              class="form-input"
              placeholder="Nombre completo del titular"
            />
            <div *ngIf="hasFieldErrors('payment.cardHolder')" class="text-red-500 text-sm mt-1">
              <i class="ri-error-warning-line"></i> Titular de la tarjeta es requerido
            </div>
          </div>

          <div>
            <label for="authorizationCode" class="form-label">C√≥digo de Autorizaci√≥n *</label>
            <input
              id="authorizationCode"
              type="text"
              formControlName="authorizationCode"
              class="form-input"
              placeholder="AUTH-xxxx"
            />
            <div *ngIf="hasFieldErrors('payment.authorizationCode')" class="text-red-500 text-sm mt-1">
              <i class="ri-error-warning-line"></i> C√≥digo de autorizaci√≥n es requerido
            </div>
          </div>
        </div>

        <!-- Mensajes de estado -->
        <div class="mt-6">
          <!-- Mensaje de carga -->
          <div *ngIf="loading" class="alert alert-info flex items-center p-4 mb-4 text-blue-800 border border-blue-300 rounded-lg bg-blue-50">
            <i class="align-baseline ri-loader-line animate-spin mr-3 text-lg"></i>
            <span class="font-medium">Enviando factura...</span>
          </div>
          
          <!-- Mensaje de error -->
          <div *ngIf="errorMsg" class="alert alert-danger flex items-center p-4 mb-4 text-red-800 border border-red-300 rounded-lg bg-red-50">
            <i class="align-baseline ri-error-warning-line mr-3 text-lg text-red-600"></i>
            <span>{{ errorMsg }}</span>
          </div>
        </div>

        <!-- Botones de acci√≥n al final de la p√°gina -->
        <div class="mt-8 pt-6 border-t border-gray-200 flex flex-wrap items-center gap-3 justify-end">
          <button type="button" class="btn btn-sub-gray hover:bg-gray-100 transition-colors" (click)="clearForm()">
            <i class="align-baseline ri-refresh-line"></i>
            Limpiar
          </button>
          <button type="submit" 
                  class="btn transition-all duration-200"
                  [class.btn-primary]="!isReturnMode"
                  [class.btn-warning]="isReturnMode"
                  [disabled]="loading || billForm.invalid" 
                  (click)="submit()">
            <i class="align-baseline" 
               [class.ri-save-line]="!isReturnMode"
               [class.ri-arrow-go-back-line]="isReturnMode"></i>
            <span *ngIf="!loading && !isReturnMode">Guardar Factura</span>
            <span *ngIf="!loading && isReturnMode">Procesar Devoluci√≥n</span>
            <span *ngIf="loading" class="flex items-center">
              <i class="ri-loader-line animate-spin mr-1"></i>
              <span *ngIf="!isReturnMode">Guardando...</span>
              <span *ngIf="isReturnMode">Procesando...</span>
            </span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
