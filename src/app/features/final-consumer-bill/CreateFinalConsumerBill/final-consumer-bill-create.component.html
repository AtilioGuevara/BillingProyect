<app-final-consumer-bill-nav></app-final-consumer-bill-nav>

<div>
  <div class="card">
    <div class="card-header">
      <div class="items-center gap-3 md:flex">
        <h6 class="grow mb-3 md:mb-0">Crear Factura Consumidor Final</h6>
        <div class="flex flex-wrap items-center gap-2 shrink-0">
          <button type="button" class="btn btn-sub-gray" (click)="clearForm()">
            <i class="align-baseline ri-refresh-line"></i>
            Limpiar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="loading" (click)="submit()">
            <i class="align-baseline ri-save-line"></i>
            <span *ngIf="!loading">Guardar Factura</span>
            <span *ngIf="loading">Guardando...</span>
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <form [formGroup]="billForm" (ngSubmit)="submit()">
        
        <!-- Información General -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Información General</h6>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Condición de pago -->
            <div>
              <label for="paymentCondition" class="form-label">Condición de pago *</label>
              <select id="paymentCondition" formControlName="paymentCondition" class="form-input">
                <option value="" disabled selected hidden>Seleccione una opción</option>
                <option value="CONTADO">Contado</option>
                <option value="CREDITO">Crédito</option>
              </select>
              <!-- Sin validación -->
            </div>
          </div>
        </div>
        
        <!-- Información del Cliente -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Información del Cliente</h6>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Nombre del cliente -->
            <div>
              <label for="customerName" class="form-label">Nombre del cliente</label>
              <input type="text" id="customerName" formControlName="customerName" class="form-input" placeholder="Nombre del cliente">
            </div>
            
            <!-- Documento del cliente -->
            <div>
              <label for="customerDocument" class="form-label">Documento del cliente</label>
              <input type="text" id="customerDocument" formControlName="customerDocument" class="form-input" placeholder="DUI del cliente">
            </div>
            
            <!-- Email del cliente -->
            <div>
              <label for="customerEmail" class="form-label">Email del cliente</label>
              <input type="email" id="customerEmail" formControlName="customerEmail" class="form-input" placeholder="cliente@email.com">
              <p *ngIf="billForm.get('customerEmail')?.hasError('email') && billForm.get('customerEmail')?.touched" class="text-red-500 text-sm mt-1">Ingrese un email válido</p>
            </div>
            
            <!-- Teléfono del cliente -->
            <div>
              <label for="customerPhone" class="form-label">Teléfono del cliente</label>
              <input type="text" id="customerPhone" formControlName="customerPhone" class="form-input" placeholder="7777-7777">
            </div>
            
            <!-- Dirección del cliente -->
            <div class="md:col-span-2">
              <label for="customerAddress" class="form-label">Dirección del cliente</label>
              <input type="text" id="customerAddress" formControlName="customerAddress" class="form-input" placeholder="Dirección del cliente">
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Productos</h6>
          <div class="space-y-4" formArrayName="products">
            <div *ngFor="let product of products.controls; let i = index" [formGroupName]="i"
                 class="grid grid-cols-1 md:grid-cols-12 gap-4 p-4 bg-gray-50 rounded-lg border">
              <!-- Número -->
              <div class="md:col-span-1 flex items-center">
                <span class="font-semibold text-gray-600">{{ i + 1 }}</span>
              </div>
              
              <!-- ID del Producto -->
              <div class="md:col-span-10">
                <label class="form-label text-sm">ID del Producto *</label>
                <input type="number" formControlName="id" class="form-input" placeholder="Ej: 1" min="1">
                <small class="text-gray-500">Ingrese el ID del producto según el catálogo del backend</small>
              </div>
              
              <!-- Acciones -->
              <div class="md:col-span-1 flex items-end">
                <button type="button" (click)="removeProduct(i)" class="btn btn-outline-danger btn-sm w-full" *ngIf="products.length > 1">
                  <i class="align-baseline ri-delete-bin-line"></i>
                </button>
              </div>
            </div>
            
            <!-- Botón agregar producto -->
            <div class="flex justify-start">
              <button type="button" (click)="addProduct()" class="btn btn-primary">
                <i class="align-bottom ri-add-line"></i> Agregar Producto
              </button>
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="mb-8">
          <h6 class="mb-4 text-lg font-semibold border-b pb-2">Observaciones</h6>
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label for="observations" class="form-label">Observaciones (Opcional)</label>
              <textarea
                id="observations"
                formControlName="observations"
                class="form-input"
                rows="3"
                placeholder="Ingrese observaciones adicionales sobre la factura"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Mensajes de estado -->
        <div class="mt-4">
          <div *ngIf="loading" class="alert alert-info">
            <i class="align-baseline ri-loader-line animate-spin"></i> Enviando factura...
          </div>
          <div *ngIf="successMsg" class="alert alert-success">
            <i class="align-baseline ri-check-circle-line"></i> {{ successMsg }}
          </div>
          <div *ngIf="errorMsg" class="alert alert-danger">
            <i class="align-baseline ri-error-warning-line"></i> {{ errorMsg }}
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
