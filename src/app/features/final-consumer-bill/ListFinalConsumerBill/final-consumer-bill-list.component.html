<app-final-consumer-bill-nav></app-final-consumer-bill-nav>

<div>
  <div class="card">
    <div class="card-header">
      <div class="items-center gap-3 md:flex">
        <h6 class="grow mb-3 md:mb-0">Lista de Facturas</h6>
        <div class="flex flex-wrap items-center gap-2 shrink-0">
          <button type="button" class="btn btn-sub-gray" (click)="loadBills()">
            <i class="align-baseline ri-refresh-line"></i>
            Actualizar
          </button>
          <button type="button" class="btn btn-primary" routerLink="/final-consumer-bill/create">
            <i class="align-baseline ri-add-line"></i>
            Nueva Factura
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Filtros por fecha -->
      <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
        <h6 class="mb-3 text-lg font-semibold text-gray-800 flex items-center">
          <i class="ri-calendar-line text-blue-600 mr-2"></i>
          Filtrar por Fecha
        </h6>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div>
            <label for="startDate" class="form-label text-sm font-medium text-gray-700">Fecha Desde</label>
            <input 
              type="date" 
              id="startDate" 
              [(ngModel)]="startDate"
              (change)="filterByDateRange()"
              class="form-input">
          </div>
          <div>
            <label for="endDate" class="form-label text-sm font-medium text-gray-700">Fecha Hasta</label>
            <input 
              type="date" 
              id="endDate" 
              [(ngModel)]="endDate"
              (change)="filterByDateRange()"
              class="form-input">
          </div>
          <div>
            <button 
              type="button" 
              (click)="clearDateFilters()" 
              class="btn btn-outline-secondary w-full">
              <i class="ri-close-line mr-1"></i>
              Limpiar Filtros
            </button>
          </div>
          <div>
            <div class="text-sm text-gray-600">
              <i class="ri-information-line mr-1"></i>
              Mostrando {{ filteredBills.length }} de {{ bills.length }} facturas
            </div>
          </div>
        </div>
      </div>

      <!-- Estados de carga y mensajes -->
      <div *ngIf="loading" class="flex items-center justify-center py-8">
        <div class="flex items-center space-x-2 text-blue-600">
          <i class="align-baseline ri-loader-line animate-spin text-xl"></i>
          <span>Cargando facturas...</span>
        </div>
      </div>

      <div *ngIf="errorMsg && !loading" class="alert alert-danger">
        <i class="align-baseline ri-error-warning-line"></i>
        {{ errorMsg }}
      </div>

      <!-- Tabla de facturas -->
      <div *ngIf="!loading && !errorMsg" class="overflow-x-auto">
        <table class="table flush" *ngIf="filteredBills.length > 0">
          <thead>
            <tr>
              <th class="whitespace-nowrap">Código de Generación</th>
              <th class="whitespace-nowrap">Número de Control</th>
              <th class="w-40 whitespace-nowrap">Fecha de Generación</th>
              <th class="w-32 whitespace-nowrap">Estado</th>
              <th class="w-24 whitespace-nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let bill of filteredBills; let i = index">
              <td>
                <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded dark:bg-gray-800">
                  {{ bill.generationCode }}
                </span>
              </td>
              <td>
                <span class="font-mono text-sm text-blue-600 dark:text-blue-400">
                  {{ bill.controlNumber }}
                </span>
              </td>
              <td>
                <div class="flex flex-col">
                  <span class="text-sm font-medium text-gray-900 dark:text-gray-100">
                    {{ getDateDisplay(bill) }}
                  </span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">
                    {{ getTimeDisplay(bill) }}
                  </span>
                </div>
              </td>
              <td>
                <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full" 
                      [ngClass]="{
                        'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200': bill.isReversed,
                        'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200': bill.originBillCode,
                        'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': bill.status === 'APPROVED' && !bill.isReversed && !bill.originBillCode,
                        'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200': bill.status === 'PENDING',
                        'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': bill.status === 'SENT',
                        'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200': !bill.status || bill.status === 'DRAFT'
                      }">
                  <i class="align-baseline mr-1" 
                     [ngClass]="{
                       'ri-arrow-go-back-line': bill.isReversed,
                       'ri-file-copy-line': bill.originBillCode,
                       'ri-check-circle-line': bill.status === 'APPROVED' && !bill.isReversed && !bill.originBillCode,
                       'ri-time-line': bill.status === 'PENDING',
                       'ri-send-plane-line': bill.status === 'SENT',
                       'ri-file-line': !bill.status || bill.status === 'DRAFT'
                     }"></i>
                  {{ getBillStatusText(bill) }}
                </span>
              </td>
              <td class="text-center">
                <div class="flex justify-center gap-2">
                  <button type="button" class="btn btn-sub-primary btn-sm" title="Ver detalles"
                  (click)="viewBillDetails(bill.generationCode)">
                    <i class="align-baseline ri-eye-line"></i>
                  </button>
                  
                  <!-- Botón de devolución -->
                  <button type="button" 
                          class="btn btn-warning btn-sm" 
                          title="Crear devolución"
                          (click)="createReturn(bill.generationCode)"
                          [disabled]="bill.isReversed || bill.originBillCode">
                    <i class="align-baseline ri-arrow-go-back-line"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Estado vacío -->
        <div *ngIf="filteredBills.length === 0 && bills.length > 0" class="text-center py-12">
          <div class="mx-auto w-24 h-24 mb-4 flex items-center justify-center bg-yellow-100 rounded-full dark:bg-yellow-900">
            <i class="ri-search-line text-3xl text-yellow-600 dark:text-yellow-400"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">No se encontraron facturas</h3>
          <p class="text-gray-500 dark:text-gray-400 mb-4">No hay facturas que coincidan con los filtros seleccionados.</p>
          <button type="button" (click)="clearDateFilters()" class="btn btn-primary">
            <i class="ri-refresh-line mr-1"></i>
            Limpiar Filtros
          </button>
        </div>

        <!-- Estado completamente vacío -->
        <div *ngIf="bills.length === 0" class="text-center py-12">
          <div class="mx-auto w-24 h-24 mb-4 flex items-center justify-center bg-gray-100 rounded-full dark:bg-gray-800">
            <i class="ri-file-list-3-line text-3xl text-gray-400 dark:text-gray-600"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-2">No hay facturas registradas</h3>
          <p class="text-gray-500 dark:text-gray-400 mb-4">Comience creando su primera factura de consumidor final.</p>
          <button type="button" class="btn btn-primary" routerLink="/final-consumer-bill/create">
            <i class="align-baseline ri-add-line"></i>
            Crear Primera Factura
          </button>
        </div>
      </div>

      <!-- Información adicional -->
      <div *ngIf="bills.length > 0" class="mt-5 p-3 bg-blue-50 rounded-lg border border-blue-200 dark:bg-blue-900/20 dark:border-blue-800">
        <p class="text-sm text-blue-700 dark:text-blue-300">
          <i class="align-baseline ri-information-line"></i> 
          <strong>Total de facturas:</strong> {{ bills.length }}
        </p>
      </div>
    </div>
  </div>
</div>
