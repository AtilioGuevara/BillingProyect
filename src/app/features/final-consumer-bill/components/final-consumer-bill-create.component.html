<div class="card">
  <div class="card-header">
    <h6 class="grow mb-3 md:mb-0 text-primary-700">Crear Factura Consumidor Final</h6>
  </div>
  <div class="card-body">
    <form [formGroup]="billForm" (ngSubmit)="submit()">
      <div class="grid grid-cols-12 gap-5">
        <div class="col-span-12 md:col-span-6">
          <label class="form-label">Código de generación</label>
          <input formControlName="generationCode" class="form-input" maxlength="36" placeholder="Código de 36 caracteres" />
          <div *ngIf="billForm.get('generationCode')?.invalid && billForm.get('generationCode')?.touched" class="text-danger text-xs mt-1">Debe tener exactamente 36 caracteres</div>
        </div>
        <div class="col-span-12 md:col-span-6">
          <label class="form-label">Número de control</label>
          <input formControlName="controlNumber" class="form-input" placeholder="DTE-03-12345678-000000000000001" />
          <div *ngIf="billForm.get('controlNumber')?.invalid && billForm.get('controlNumber')?.touched" class="text-danger text-xs mt-1">Formato: DTE-03-12345678-000000000000001</div>
        </div>
      </div>
      
      <div class="border-t border-gray-200 my-6"></div>
      
      <div class="mb-6">
        <h6 class="text-lg font-semibold text-primary-700 mb-4">Productos</h6>
        <div formArrayName="products">
          <div *ngFor="let product of products.controls; let i = index" [formGroupName]="i" class="grid grid-cols-12 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
            <div class="col-span-12 md:col-span-4">
              <label class="form-label">Producto</label>
              <input formControlName="name" class="form-input" placeholder="Nombre del producto" />
            </div>
            <div class="col-span-12 md:col-span-3">
              <label class="form-label">Cantidad</label>
              <input type="number" formControlName="quantity" class="form-input" placeholder="1" />
            </div>
            <div class="col-span-12 md:col-span-3">
              <label class="form-label">Precio</label>
              <input type="number" formControlName="price" class="form-input" placeholder="0.00" step="0.01" />
            </div>
            <div class="col-span-12 md:col-span-2 flex items-end">
              <button type="button" (click)="removeProduct(i)" class="btn btn-outline-danger btn-sm w-full" *ngIf="products.length > 1">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </div>
          </div>
          <button type="button" (click)="addProduct()" class="btn btn-outline-primary">
            <i class="fas fa-plus"></i> Agregar producto
          </button>
        </div>
      </div>
      
      <div class="border-t border-gray-200 my-6"></div>
      
      <div class="mb-6">
        <h6 class="text-lg font-semibold text-primary-700 mb-4">Totales</h6>
        <div class="grid grid-cols-12 gap-5">
          <div class="col-span-12 md:col-span-4">
            <label class="form-label">Ventas no gravadas</label>
            <input type="number" formControlName="nonTaxedSales" class="form-input" placeholder="0.00" step="0.01" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="form-label">Ventas exentas</label>
            <input type="number" formControlName="exemptSales" class="form-input" placeholder="0.00" step="0.01" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="form-label">Ventas gravadas</label>
            <input type="number" formControlName="taxedSales" class="form-input" placeholder="0.00" step="0.01" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="form-label">IVA (13%)</label>
            <input type="number" formControlName="iva" class="form-input" placeholder="0.00" step="0.01" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="form-label">IVA percibido</label>
            <input type="number" formControlName="perceivedIva" class="form-input" placeholder="0.00" step="0.01" />
          </div>
          <div class="col-span-12 md:col-span-4">
            <label class="form-label">IVA retenido</label>
            <input type="number" formControlName="withheldIva" class="form-input" placeholder="0.00" step="0.01" />
          </div>
          <div class="col-span-12 md:col-span-6">
            <label class="form-label font-bold">Total con IVA</label>
            <input type="number" formControlName="totalWithIva" class="form-input font-bold text-lg" placeholder="0.00" step="0.01" />
          </div>
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button type="button" class="btn btn-outline-secondary" (click)="billForm.reset()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="loading || billForm.invalid">
          <i class="fas fa-save"></i> 
          <span *ngIf="!loading">Crear Factura</span>
          <span *ngIf="loading">Creando...</span>
        </button>
      </div>
      
      <div class="mt-4">
        <div *ngIf="loading" class="alert alert-info">
          <i class="fas fa-spinner fa-spin"></i> Enviando factura...
        </div>
        <div *ngIf="successMsg" class="alert alert-success">
          <i class="fas fa-check-circle"></i> {{ successMsg }}
        </div>
        <div *ngIf="errorMsg" class="alert alert-danger">
          <i class="fas fa-exclamation-circle"></i> {{ errorMsg }}
        </div>
      </div>
    </form>
  </div>
</div>
